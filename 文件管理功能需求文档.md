# 文件管理功能需求文档

## 1. 功能概述

### 1.1 目标
在桌面系统中增加类似网盘的文件管理功能，支持用户通过拖拽方式上传本地文件到浏览器桌面，以APP图标风格展示不同文件类型，支持文件下载和管理。

### 1.2 核心功能
- **文件上传**：支持拖拽上传，左下角显示上传进度
- **桌面展示**：按文件类型显示图标，支持双击操作
- **文件下载**：双击文件图标弹出下载确认框
- **后台管理**：新增"文件管理"页面，支持文件列表、删除、下载等操作

### 1.3 支持的文件类型
- 图片（jpg, png, gif, webp, svg等）
- 视频（mp4, avi, mov, wmv等）
- Word文档（doc, docx）
- Excel表格（xls, xlsx）
- 压缩包（zip, rar, 7z等）
- 其他文件类型

## 2. 数据库设计

### 2.1 文件表结构 (files)
```sql
CREATE TABLE IF NOT EXISTS files (
    id VARCHAR(36) PRIMARY KEY,
    original_name VARCHAR(255) NOT NULL COMMENT '原始文件名',
    stored_name VARCHAR(255) NOT NULL COMMENT '存储文件名',
    file_path VARCHAR(500) NOT NULL COMMENT '文件存储路径',
    mime_type VARCHAR(100) NOT NULL COMMENT 'MIME类型',
    file_size BIGINT NOT NULL COMMENT '文件大小(字节)',
    type_category ENUM('image', 'video', 'word', 'excel', 'archive', 'other') NOT NULL COMMENT '文件类型分类',
    file_url VARCHAR(500) COMMENT '可访问的文件URL',
    uploader_id VARCHAR(36) COMMENT '上传者ID',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_uploader (uploader_id),
    INDEX idx_type_category (type_category),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 2.2 数据库初始化脚本修改
需要在 `server/data/init.sql` 中添加上述表结构。

## 3. 后端API设计

### 3.1 文件上传
```
POST /api/files/upload
Content-Type: multipart/form-data

参数：
- file: 文件对象（支持多文件）
- type: 文件类型分类（可选，自动识别）

响应：
{
  "success": true,
  "data": {
    "id": "uuid",
    "originalName": "example.jpg",
    "storedName": "uuid_example.jpg",
    "fileSize": 1024000,
    "mimeType": "image/jpeg",
    "typeCategory": "image",
    "fileUrl": "/uploads/files/uuid_example.jpg",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

### 3.2 文件列表
```
GET /api/files?page=1&limit=20&type=image&search=example

响应：
{
  "success": true,
  "data": {
    "files": [...],
    "pagination": {
      "page": 1,
      "limit": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

### 3.3 文件下载
```
GET /api/files/:id/download

响应：
- 文件流 + Content-Disposition header
```

### 3.4 文件删除
```
DELETE /api/files/:id

响应：
{
  "success": true,
  "message": "文件删除成功"
}
```

### 3.5 文件信息
```
GET /api/files/:id

响应：
{
  "success": true,
  "data": {
    "id": "uuid",
    "originalName": "example.jpg",
    "fileSize": 1024000,
    "mimeType": "image/jpeg",
    "typeCategory": "image",
    "fileUrl": "/uploads/files/uuid_example.jpg",
    "createdAt": "2024-01-01T00:00:00.000Z"
  }
}
```

## 4. 前端组件设计

### 4.1 核心组件
- `FileUploadProgress.vue` - 左下角上传进度组件
- `DesktopFileIcon.vue` - 桌面文件图标组件
- `ConfirmDownloadModal.vue` - 下载确认弹窗
- `FileManagement.vue` - 后台文件管理页面

### 4.2 新增Composable
- `useFiles.js` - 文件管理相关逻辑

### 4.3 文件类型图标映射
```javascript
const FILE_TYPE_ICONS = {
  image: '/apps/icons/image-128.png',
  video: '/apps/icons/video-128.png',
  word: '/apps/icons/word-128.png',
  excel: '/apps/icons/excel-128.png',
  archive: '/apps/icons/archive-128.png',
  other: '/apps/icons/file-128.png'
};
```

## 5. 实现阶段

### 5.1 MVP阶段（优先级：高）
1. **后端基础**
   - 创建文件数据模型
   - 实现文件上传接口
   - 实现文件下载接口
   - 实现文件列表接口
   - 实现文件删除接口

2. **前端基础**
   - 实现桌面拖拽上传功能
   - 实现左下角上传进度组件
   - 实现桌面文件图标显示
   - 实现双击下载确认弹窗

3. **后台管理**
   - 新增"文件管理"菜单项
   - 实现文件列表页面
   - 实现文件删除功能

### 5.2 增强阶段（优先级：中）
1. **用户体验优化**
   - 文件预览功能（图片、视频）
   - 批量上传/下载
   - 文件重命名功能


### 5.3 高级阶段（优先级：低）
1. **性能优化**
   - 图片缩略图生成


## 6. 技术实现要点

### 6.1 文件上传
- 使用 `FormData` 处理文件上传
- 实现上传进度监听
- 支持多文件同时上传
- 文件类型和大小验证

### 6.2 文件存储
- 本地存储路径：`server/uploads/files/`
- 文件名使用UUID避免冲突
- 保留原始文件扩展名

### 6.3 安全考虑
- 文件大小限制(不能超出服务器容量)
- 文件名安全处理（防止路径穿越）

### 6.4 用户体验
- 拖拽上传视觉反馈
- 上传进度实时显示
- 上传失败重试机制

## 7. 文件结构变更

### 7.1 后端新增文件
```
server/src/
├── models/
│   └── file.model.js
├── controllers/
│   └── file.controller.js
├── services/
│   └── file.service.js
├── routes/
│   └── files.routes.js
└── uploads/
    └── files/
```

### 7.2 前端新增文件
```
client/src/
├── components/
│   ├── desktop/
│   │   └── DesktopFileIcon.vue
│   ├── file/
│   │   ├── FileUploadProgress.vue
│   │   └── ConfirmDownloadModal.vue
│   └── management/
│       └── FileManagement.vue
├── composables/
│   └── useFiles.js
└── views/
    └── FileManagement.vue
```

### 7.3 静态资源
```
client/public/apps/icons/
├── image-128.png
├── video-128.png
├── word-128.png
├── excel-128.png
├── archive-128.png
└── file-128.png
```
