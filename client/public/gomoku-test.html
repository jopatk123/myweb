<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>五子棋房间功能测试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-section { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button { 
            padding: 8px 16px; 
            margin: 5px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            background: #007bff; 
            color: white;
        }
        input { 
            padding: 8px; 
            margin: 5px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
        }
        .room-list { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 15px; 
            margin-top: 15px;
        }
        .room-card { 
            border: 1px solid #ddd; 
            padding: 15px; 
            border-radius: 8px; 
            background: #f9f9f9;
        }
        .status { 
            color: #666; 
            font-size: 12px; 
            margin: 5px 0;
        }
        .connected { color: green; }
        .disconnected { color: red; }
    </style>
</head>
<body>
    <h1>五子棋多人模式测试</h1>
    
    <div class="test-section">
        <h3>连接状态</h3>
        <p id="connectionStatus" class="status disconnected">未连接</p>
        <button onclick="connectWS()">连接WebSocket</button>
        <button onclick="disconnectWS()">断开连接</button>
    </div>
    
    <div class="test-section">
        <h3>房间操作</h3>
        <input type="text" id="playerName" placeholder="玩家昵称" value="测试玩家">
        <button onclick="createRoom()">创建房间</button>
        <br>
        <input type="text" id="roomCode" placeholder="房间码">
        <button onclick="joinRoom()">加入房间</button>
        <button onclick="getRoomList()">获取房间列表</button>
    </div>
    
    <div class="test-section">
        <h3>当前房间信息</h3>
        <div id="currentRoom">未加入任何房间</div>
    </div>
    
    <div class="test-section">
        <h3>房间列表</h3>
        <div id="roomList" class="room-list">暂无房间</div>
    </div>
    
    <div class="test-section">
        <h3>消息日志</h3>
        <div id="messageLog" style="height: 200px; overflow-y: auto; background: #f0f0f0; padding: 10px; border-radius: 4px;">
        </div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        let ws = null;
        let sessionId = 'test-session-' + Math.random().toString(36).substr(2, 9);
        
        function log(message) {
            const logDiv = document.getElementById('messageLog');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = '已连接';
                statusEl.className = 'status connected';
            } else {
                statusEl.textContent = '未连接';
                statusEl.className = 'status disconnected';
            }
        }
        
        function connectWS() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                log('WebSocket 已经连接');
                return;
            }
            
            ws = new WebSocket('ws://localhost:3302/ws');
            
            ws.onopen = function() {
                log('WebSocket 连接成功');
                updateConnectionStatus(true);
                
                // 发送会话初始化
                ws.send(JSON.stringify({
                    type: 'init_session',
                    data: { sessionId: sessionId }
                }));
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                log(`收到消息: ${message.type}`);
                console.log('WebSocket message:', message);
                
                handleMessage(message);
            };
            
            ws.onclose = function() {
                log('WebSocket 连接关闭');
                updateConnectionStatus(false);
            };
            
            ws.onerror = function(error) {
                log('WebSocket 错误: ' + error);
                updateConnectionStatus(false);
            };
        }
        
        function disconnectWS() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function sendMessage(type, data) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('WebSocket 未连接，无法发送消息');
                return;
            }
            
            const message = { type, data };
            ws.send(JSON.stringify(message));
            log(`发送消息: ${type}`);
        }
        
        function handleMessage(message) {
            switch (message.type) {
                case 'gomoku_room_created':
                    displayCurrentRoom(message.data);
                    log(`房间创建成功: ${message.data.room?.room_code}`);
                    break;
                    
                case 'gomoku_room_joined':
                    displayCurrentRoom(message.data);
                    log(`加入房间成功: ${message.data.room?.room_code}`);
                    break;
                    
                case 'gomoku_room_list':
                    displayRoomList(message.data.rooms || []);
                    log(`收到房间列表: ${message.data.rooms?.length || 0} 个房间`);
                    break;
                    
                case 'gomoku_error':
                    log(`错误: ${message.data.message}`);
                    break;
                    
                default:
                    log(`未处理的消息类型: ${message.type}`);
            }
        }
        
        function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                log('请输入玩家昵称');
                return;
            }
            
            sendMessage('gomoku_create_room', { playerName });
        }
        
        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim();
            
            if (!playerName) {
                log('请输入玩家昵称');
                return;
            }
            
            if (!roomCode) {
                log('请输入房间码');
                return;
            }
            
            sendMessage('gomoku_join_room', { playerName, roomCode });
        }
        
        function getRoomList() {
            sendMessage('gomoku_get_room_list', {});
        }
        
        function displayCurrentRoom(data) {
            const roomDiv = document.getElementById('currentRoom');
            if (data && data.room) {
                const room = data.room;
                roomDiv.innerHTML = `
                    <strong>房间码:</strong> ${room.room_code}<br>
                    <strong>状态:</strong> ${room.status}<br>
                    <strong>玩家数:</strong> ${room.players?.length || 0}/2<br>
                    <strong>创建时间:</strong> ${new Date(room.created_at).toLocaleString()}
                `;
            } else {
                roomDiv.innerHTML = '未加入任何房间';
            }
        }
        
        function displayRoomList(rooms) {
            const listDiv = document.getElementById('roomList');
            if (rooms.length === 0) {
                listDiv.innerHTML = '<div class="room-card">暂无活跃房间</div>';
                return;
            }
            
            listDiv.innerHTML = rooms.map(room => `
                <div class="room-card">
                    <h4>房间: ${room.room_code}</h4>
                    <p><strong>状态:</strong> ${getStatusText(room.status)}</p>
                    <p><strong>玩家:</strong> ${room.current_players}/${room.max_players}</p>
                    <p><strong>创建时间:</strong> ${new Date(room.created_at).toLocaleTimeString()}</p>
                    <button onclick="joinRoomByCode('${room.room_code}')">加入房间</button>
                </div>
            `).join('');
        }
        
        function joinRoomByCode(roomCode) {
            document.getElementById('roomCode').value = roomCode;
            joinRoom();
        }
        
        function getStatusText(status) {
            const statusMap = {
                'waiting': '等待中',
                'playing': '游戏中',
                'finished': '已结束'
            };
            return statusMap[status] || status;
        }
        
        function clearLog() {
            document.getElementById('messageLog').innerHTML = '';
        }
        
        // 页面加载时自动连接
        window.addEventListener('load', function() {
            connectWS();
        });
    </script>
</body>
</html>
